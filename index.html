<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Nối file PDF và hình</title>
  <link rel="icon" href="assets/favicon.png" type="image/png">
  <script src="lib/pdf-lib.min.js"></script>
  <script src="lib/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'lib/pdf.worker.min.js';
  </script>
  <script src="lib/Sortable.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #1e1e2f;
      color: #fff;
      padding: 20px;
    }

    h2 {
      margin-top: 30px;
    }

    .list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .page-thumb {
      border: 2px solid #555;
      padding: 5px;
      background: #2e2e3e;
      width: 120px;
      cursor: grab;
    }

    img,
    canvas {
      width: 100%;
      display: block;
    }

    button {
      margin-top: 20px;
      padding: 10px 15px;
      font-size: 16px;
    }

    .page-thumb {
      position: relative;
      border: 2px solid #555;
      padding: 5px;
      background: #2e2e3e;
      width: 120px;
      cursor: grab;
    }

    .page-thumb:hover .delete-btn {
      display: block;
    }

    .delete-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(149, 125, 125, 0.8);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      padding: 2px 6px;
      cursor: pointer;
      display: none;
      z-index: 1;
    }
  </style>
</head>

<body>
  <h1>Nối file PDF và hình</h1>

  <input type="file" id="pdfInput" accept=".pdf" multiple />
  <input type="file" id="imgInput" accept="image/*" multiple />

  <h2>Bản xem trước (kéo thả để sắp xếp thứ tự):</h2>
  <div id="pages" class="list"></div>

  <button id="exportBtn">Xuất file PDF</button>

  <script>
    let originalPdfFileName = 'combined';
    let refWidth = 595.28;
    let refHeight = 841.89;
    let pages = []; // { type: 'pdf'|'image', content: ArrayBuffer|Image }

    document.getElementById('pdfInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      for (const file of e.target.files) {
        try {
          const pdfBytes = await file.arrayBuffer();
          const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
          const refPage = pdfDoc.getPage(0);
          refWidth = refPage.getSize().width;
          refHeight = refPage.getSize().height;
          const pageCount = pdfDoc.getPageCount();
          for (let i = 0; i < pageCount; i++) {
            const copiedPdf = await PDFLib.PDFDocument.create();
            const [page] = await copiedPdf.copyPages(pdfDoc, [i]);
            copiedPdf.addPage(page);
            const singlePageBytes = await copiedPdf.save();
            pages.push({ type: 'pdf', content: singlePageBytes });
            addThumbnail(URL.createObjectURL(new Blob([singlePageBytes])), pages.length - 1, false);
          }
          originalPdfFileName = file.name.replace(/\.pdf$/i, '');
        }
        catch (err) {
          e.target.value = ''
          console.error('Invalid PDF file:', err);
          alert('Không thể đọc được tệp PDF này.');
        }
      }
      e.target.value = '';
    });

    document.getElementById('imgInput').addEventListener('change', async (e) => {
      const files = e.target.files;
      for (const file of files) {
        const imgBytes = await file.arrayBuffer();
        const imgPdf = await PDFLib.PDFDocument.create();

        // Embed image depending on type
        const image = file.type.includes('png')
          ? await imgPdf.embedPng(imgBytes)
          : await imgPdf.embedJpg(imgBytes);

        // Add page with reference size
        const page = imgPdf.addPage([refWidth, refHeight]);

        // Get image original size
        const { width: imgW, height: imgH } = image;

        // Calculate scale to fit
        const scale = Math.min(refWidth / imgW, refHeight / imgH);
        const scaledWidth = imgW * scale;
        const scaledHeight = imgH * scale;

        // Center the image
        const x = (refWidth - scaledWidth) / 2;
        const y = (refHeight - scaledHeight) / 2;

        // Draw the image
        page.drawImage(image, {
          x,
          y,
          width: scaledWidth,
          height: scaledHeight
        });

        // Save this one-page PDF to add into your page list
        const imgPageBytes = await imgPdf.save();

        // Store in your page array
        pages.push({ type: 'pdf', content: imgPageBytes });

        // Generate a thumbnail for preview
        const blobUrl = URL.createObjectURL(new Blob([imgPageBytes], { type: 'application/pdf' }));
        addThumbnail(blobUrl, pages.length - 1, false);
      }
      e.target.value = '';
    });

    function updateExportButton() {
      const exportBtn = document.getElementById('exportBtn');
      exportBtn.textContent = `Xuất file PDF (${pages.length} trang)`;
    }
    function reindexThumbnails() {
      const thumbs = document.querySelectorAll('.page-thumb');
      thumbs.forEach((div, i) => div.dataset.index = i);
    }

    function addThumbnail(url, index, isImage = true) {
      const container = document.getElementById('pages');
      const div = document.createElement('div');
      div.className = 'page-thumb';
      div.dataset.index = index;

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerText = '❌';
      deleteBtn.title = 'Xoá trang';
      deleteBtn.onclick = () => {
        const confirmDelete = confirm('Bạn có chắc chắn muốn xoá trang này?');
        if (confirmDelete) {
          div.remove();
          pages.splice(div.dataset.index, 1);
          reindexThumbnails();
          updateExportButton();
        }
      };
      div.appendChild(deleteBtn);

      if (isImage) {
        const img = document.createElement('img');
        img.src = url;
        div.appendChild(img);
      } else {
        const canvas = document.createElement('canvas');
        div.appendChild(canvas);
        const loadingTask = pdfjsLib.getDocument(url);
        loadingTask.promise.then(pdf => {
          pdf.getPage(1).then(page => {
            const viewport = page.getViewport({ scale: 0.3 });
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            page.render({ canvasContext: context, viewport });
          });
        });
      }

      container.appendChild(div);
      updateExportButton();
    }

    new Sortable(document.getElementById('pages'), {
      animation: 150,
      onEnd: () => {
        // update pages array order
        const newOrder = [];
        const children = document.querySelectorAll('.page-thumb');
        for (const child of children) {
          const idx = parseInt(child.dataset.index);
          newOrder.push(pages[idx]);
        }
        pages = newOrder;

        // update indices
        children.forEach((child, i) => child.dataset.index = i);
      }
    });

    document.getElementById('exportBtn').addEventListener('click', async () => {
      const pdfDoc = await PDFLib.PDFDocument.create();
      for (const page of pages) {
        if (page.type === 'pdf') {
          const tempDoc = await PDFLib.PDFDocument.load(page.content);
          const [copiedPage] = await pdfDoc.copyPages(tempDoc, [0]);
          pdfDoc.addPage(copiedPage);
        } else if (page.type === 'image') {
          let imgEmbed;
          if (page.fileType === 'image/jpeg') {
            imgEmbed = await pdfDoc.embedJpg(page.content);
          } else {
            imgEmbed = await pdfDoc.embedPng(page.content);
          }
          const pageRef = pdfDoc.addPage([imgEmbed.width, imgEmbed.height]);
          pageRef.drawImage(imgEmbed, {
            x: 0,
            y: 0,
            width: imgEmbed.width,
            height: imgEmbed.height
          });
        }
      }
      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = originalPdfFileName + '_pgh.pdf';;
      link.click();
    });
  </script>
</body>

</html>